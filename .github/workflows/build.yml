name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: Install dependencies
      run: |
        cd app
        npm install
    
    - name: Build Windows app (installer & portable)
      if: matrix.os == 'windows-latest'
      run: |
        cd app
        npm run electron:build:win

    - name: Build macOS x64 app
      if: matrix.os == 'macos-latest'
      run: |
        cd app
        npm run electron:build:mac

    - name: Build macOS ARM64 app
      if: matrix.os == 'macos-latest'
      run: |
        cd app
        npm run electron:build:mac:arm64

    - name: Build Linux x64 app
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd app
        npm run electron:build:linux

    - name: Build Linux ARM64 app
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd app
        npm run electron:build:linux:arm64

    - name: Build Linux ARMv7l app
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd app
        npm run electron:build:linux:armv7l
    
    - name: Upload Windows artifacts
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: windows-builds
        path: |
          app/dist/*Windows-Portable*.exe
          app/dist/*Windows-Installer*.exe
        if-no-files-found: warn
        
    - name: List macOS artifacts
      if: matrix.os == 'macos-latest'
      run: |
        cd app
        ls -la dist/

    - name: Upload macOS x64 artifacts
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-x64-builds
        path: app/dist/*macOS-x64*.dmg
        if-no-files-found: warn

    - name: Upload macOS ARM64 artifacts
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-arm64-builds
        path: app/dist/*macOS-arm64*.dmg
        if-no-files-found: warn
        
    - name: List Linux artifacts
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd app
        ls -la dist/

    - name: Upload Linux x64 artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-x64-builds
        path: |
          app/dist/*Linux-x64*.AppImage
          app/dist/*Linux-x64*.deb
          app/dist/*Linux-x64*.rpm
        if-no-files-found: warn

    - name: Upload Linux ARM64 artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-arm64-builds
        path: |
          app/dist/*Linux-arm64*.AppImage
          app/dist/*Linux-arm64*.deb
          app/dist/*Linux-arm64*.rpm
        if-no-files-found: warn

    - name: Upload Linux ARMv7l artifacts
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-armv7l-builds
        path: |
          app/dist/*Linux-armv7l*.AppImage
          app/dist/*Linux-armv7l*.deb
          app/dist/*Linux-armv7l*.rpm
        if-no-files-found: warn